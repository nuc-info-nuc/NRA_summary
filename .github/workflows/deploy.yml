name: deploy-site
on:
  push:
    branches:
      - main # あなたのメインブランチ名に合わせてください

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare docs
        run: |
          mkdir -p docs

          # 1. 最新リストのヘッダー作成
          echo "### 最新の公開会合 (直近5件)" > latest_list.txt

          # 2. ファイル名の逆順(ls -r)でループを回し、先頭5件の1行目(タイトル)を取得
          # 2025-01-02.md などのファイルを対象とし、READMEなどは除外
          ls -r *.md | grep -vE "README.md|index.md" | head -n 5 | while read file; do
            # 1行目を取得し、Markdownの「# 」を削除してタイトルにする
            title=$(head -n 1 "$file" | sed 's/^# //')
            # リンク付きのリスト形式で書き出す
            echo "* [$title]($file)" >> latest_list.txt
          done

          # 3. docs/index.md の作成（最新リスト + 元のREADME）
          cat latest_list.txt > docs/index.md
          echo -e "\n---\n" >> docs/index.md
          cat README.md >> docs/index.md

          # 4. 全ファイルを docs にコピー
          cp -v *.md docs/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install dependencies
        run: |
          pip install mkdocs-material[social] pillow cairosvg

      - name: Build
        run: mkdocs build

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site # mkdocs build で生成されるデフォルトのフォルダ
