name: deploy-site
on:
  push:
    branches:
      - main # あなたのメインブランチ名に合わせてください

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare docs
        run: |
          mkdir -p docs

          # 1. 最新5件のリストを作成 (README.mdとindex.md、.pages、.github以外)
          echo "### 最新の公開会合 (直近5件)" > latest_list.txt
          ls -t *.md | grep -vE "README.md|index.md" | head -n 5 | while read line; do
            # ファイル名からリンクを作成（例: [2024-01-01_会議名](2024-01-01_会議名.md)）
            title=$(basename "$line" .md)
            echo "* [$title]($line)" >> latest_list.txt
          done

          # 2. README.md の冒頭に最新リストを挿入して docs/index.md を作成
          cat latest_list.txt > docs/index.md
          echo "" >> docs/index.md
          echo "---" >> docs/index.md
          cat README.md >> docs/index.md

          # 3. 残りの全ファイルを docs にコピー
          cp -v *.md docs/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install dependencies
        run: |
          pip install mkdocs-material[social] pillow cairosvg

      - name: Build
        run: mkdocs build

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site # mkdocs build で生成されるデフォルトのフォルダ
